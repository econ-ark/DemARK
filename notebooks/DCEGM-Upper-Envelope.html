
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>DCEGM Upper Envelope &#8212; DemARK</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/DCEGM-Upper-Envelope';</script>
    <link rel="icon" href="../_static/econ-ark-logo-small.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The Diamond OLG Model" href="DiamondOLG.html" />
    <link rel="prev" title="Do Precautionary Motives Explain China’s High Saving Rate?" href="Chinese-Growth.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/econ-ark-logo.png" class="logo__image only-light" alt="DemARK - Home"/>
    <script>document.write(`<img src="../_static/econ-ark-logo.png" class="logo__image only-dark" alt="DemARK - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../README.html">
                    DemARK
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Alternative-Combos-Of-Parameter-Values.html">Alternative Combinations of Parameter Values</a></li>


<li class="toctree-l1"><a class="reference internal" href="ChangeLiqConstr.html">What Happens To the Consumption Function When A Liquidity Constraint is Tightened?</a></li>
<li class="toctree-l1"><a class="reference internal" href="Chinese-Growth.html">Do Precautionary Motives Explain China’s High Saving Rate?</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">DCEGM Upper Envelope</a></li>






<li class="toctree-l1"><a class="reference internal" href="DiamondOLG.html">The Diamond OLG Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="FisherTwoPeriod.html">The Fisher Two-Period Optimal Consumption Problem</a></li>

<li class="toctree-l1"><a class="reference internal" href="Gentle-Intro-To-HARK-Buffer-Stock-Model.html">A Gentle Introduction to HARK: Buffer Stock Saving</a></li>
<li class="toctree-l1"><a class="reference internal" href="Gentle-Intro-To-HARK-PerfForesightCRRA.html">A Gentle Introduction to HARK: The Perfect Foresight Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="Harmenberg-Aggregation.html">A Demonstration of the Harmenberg (2021) Aggregation Method</a></li>







<li class="toctree-l1"><a class="reference internal" href="IncExpectationExample.html">The Persistent Shock Model and Income Expectations</a></li>
<li class="toctree-l1"><a class="reference internal" href="KeynesFriedmanModigliani.html">Introduction: Keynes, Friedman, Modigliani</a></li>
<li class="toctree-l1"><a class="reference internal" href="LC-Model-Expected-Vs-Realized-Income-Growth.html">Expectated vs Realized Income Growth in A Standard Life Cycle Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="LifeCycleModelTheoryVsData.html">The Life Cycle Model: Theory vs Data</a></li>

<li class="toctree-l1"><a class="reference internal" href="Lucas-Asset-Pricing-Model.html">Lucas Asset Pricing Model</a></li>





<li class="toctree-l1"><a class="reference internal" href="MPC-Out-of-Credit-vs-MPC-Out-of-Income.html">The MPC out of Credit vs the MPC Out of Income</a></li>
<li class="toctree-l1"><a class="reference internal" href="Micro-and-Macro-Implications-of-Very-Impatient-HHs.html">Micro- and Macroeconomic Implications of Very Impatient Households</a></li>

<li class="toctree-l1"><a class="reference internal" href="Nondurables-During-Great-Recession.html">Spending on Nondurables During the Great Recession</a></li>
<li class="toctree-l1"><a class="reference internal" href="PerfForesightCRRA-Approximation.html">Perfect Foresight CRRA Model - Approximation</a></li>
<li class="toctree-l1"><a class="reference internal" href="PerfForesightCRRA-SavingRate.html">Perfect Foresight CRRA Model - Saving Rate</a></li>
<li class="toctree-l1"><a class="reference internal" href="Structural-Estimates-From-Empirical-MPCs-Fagereng-et-al.html">Making Structural Estimates From Empirical Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="TractableBufferStock-Interactive.html">The Tractable Buffer Stock Model</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/econ-ark/DemARK/master?urlpath=lab/tree/notebooks/DCEGM-Upper-Envelope.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://hub.econ-ark.org/hub/user-redirect/git-pull?repo=https%3A//github.com/econ-ark/DemARK&urlpath=lab/tree/DemARK/notebooks/DCEGM-Upper-Envelope.ipynb&branch=master" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on JupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="JupyterHub logo" src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/econ-ark/DemARK/blob/master/notebooks/DCEGM-Upper-Envelope.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/DCEGM-Upper-Envelope.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>DCEGM Upper Envelope</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">DCEGM Upper Envelope</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-endogenous-grid-method-for-discrete-continuous-dynamic-choice-models-with-or-without-taste-shocks">“The endogenous grid method for discrete-continuous dynamic choice models with (or without) taste shocks”</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#upper-envelopes">Upper envelopes</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#an-example-writing-a-will">An example: writing a will</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#author-mateo-velasquez-giraldo">Author: Mateo Velásquez-Giraldo</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#the-third-last-period-of-life">The third (last) period of life</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-agent-without-a-will">The agent without a will</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-agent-with-a-will">The agent with a will</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#the-second-period">The second period</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-agent-who-decides-not-to-write-a-will">An agent who decides not to write a will</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-agent-who-decides-to-write-a-will">An agent who decides to write a will</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-decision-whether-to-write-a-will-or-not">The decision whether to write a will or not</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#the-first-period">The first period</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="dcegm-upper-envelope">
<h1>DCEGM Upper Envelope<a class="headerlink" href="#dcegm-upper-envelope" title="Link to this heading">#</a></h1>
<section id="the-endogenous-grid-method-for-discrete-continuous-dynamic-choice-models-with-or-without-taste-shocks">
<h2><a class="reference external" href="https://onlinelibrary.wiley.com/doi/abs/10.3982/QE643">“The endogenous grid method for discrete-continuous dynamic choice models with (or without) taste shocks”</a><a class="headerlink" href="#the-endogenous-grid-method-for-discrete-continuous-dynamic-choice-models-with-or-without-taste-shocks" title="Link to this heading">#</a></h2>
<p style="text-align: center;"><small><small><small>For the following badges: GitHub does not allow click-through redirects; right-click to get the link, then paste into navigation bar</small></small></small></p>
<p><a class="reference external" href="https://econ-ark.org/materials/dcegm-upper-envelope#launch"><img alt="badge" src="https://img.shields.io/badge/Launch%20using%20-Econ--ARK-blue" /></a></p>
<p>This notebook provides a simple introduction to the “DCEGM” algorithm <cite data-cite="6202365/4F64GG8F"></cite>. DCEGM extends the EGM method proposed in <cite data-cite="6202365/HQ6H9JEI"></cite> to problems with both continuous (e.g. consumption) and discrete (e.g. retirement) decisions.</p>
<p>The main challenge for the EGM algorithm in discrete-continuous problems is that the discrete decisions generate “kinks” in the value function, making it non-concave and rendering the first order condition used by EGM a necessary but not sufficient for optimality. In practice, this causes the EGM inversion step to produce (resource, consumption) points that are not optimal. DCEGM incorporates a method to filter the points produced by EGM so that only the truly optimal ones are used in producing an approximation to the solution.</p>
<p>This filtering process consists mainly of computing “upper-envelopes” of the candidate points: lines that are made up only of the points with the higher values.</p>
<p>This notebook presents HARK’s tool for calculating upper-envelopes and then uses it to solve a simple three-period discrete-continuous problem using DCEGM.</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="upper-envelopes">
<h1>Upper envelopes<a class="headerlink" href="#upper-envelopes" title="Link to this heading">#</a></h1>
<p>Start by importing the tools.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># imports</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">HARK.rewards</span> <span class="kn">import</span> <span class="n">CRRAutility</span><span class="p">,</span> <span class="n">CRRAutilityP</span><span class="p">,</span> <span class="n">CRRAutilityP_inv</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># here for now, should be</span>
<span class="c1"># from HARK import discontools or whatever name is chosen</span>
<span class="kn">from</span> <span class="nn">HARK.interpolation</span> <span class="kn">import</span> <span class="n">LinearInterp</span>
<span class="kn">from</span> <span class="nn">HARK.dcegm</span> <span class="kn">import</span> <span class="n">calc_nondecreasing_segments</span><span class="p">,</span> <span class="n">upper_envelope</span>
</pre></div>
</div>
</div>
</div>
<p>Applying EGM to value functions with kinks, as the ones that result from discrete-continuous problems, will often result in grids for market resources that are not monotonic and candidate choices at those points that are sub-optimal.
Consider the following example output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_egm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">])</span>
<span class="n">c_egm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.36</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
<span class="n">vt_egm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_egm</span><span class="p">,</span> <span class="n">vt_egm</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Resources&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Value&#39;)
</pre></div>
</div>
<img alt="../_images/70c2b99652dccc9b535b99702e2661629d7ef36c4bead2cf2c7e2743f99e632c.png" src="../_images/70c2b99652dccc9b535b99702e2661629d7ef36c4bead2cf2c7e2743f99e632c.png" />
</div>
</div>
<p>There are two main issues:</p>
<ul class="simple">
<li><p>The line implied by the points “goes backwards” at some points. This is because the m-grid is not monotonic.</p></li>
<li><p>Some segments of the line are under other segments of the line. This means that we have sub-optimal points.</p></li>
</ul>
<p>A first step in filtering out sub-optimal points is to split the previous line in its non-decreasing segments. This is achieved by HARK’s function <code class="docutils literal notranslate"><span class="pre">calc_segments</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute non-decreasing segments</span>
<span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">calc_nondecreasing_segments</span><span class="p">(</span><span class="n">m_egm</span><span class="p">,</span> <span class="n">vt_egm</span><span class="p">)</span>

<span class="c1"># Plot them, and store them as [m, v] pairs</span>
<span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">end</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_egm</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vt_egm</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">m_egm</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vt_egm</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;transformed values&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ec6ee74d8011409f5cb429515a7017127b0e9a59b899bb115a6d9e8b2ca3905c.png" src="../_images/ec6ee74d8011409f5cb429515a7017127b0e9a59b899bb115a6d9e8b2ca3905c.png" />
</div>
</div>
<p>The next step is to produce the upper-envelope of these segments: a line comprised of the points that are not under any other segment. This is done by HARK’s <code class="docutils literal notranslate"><span class="pre">upper_envelope</span></code>function. We now apply it and plot the result</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The function defines the upper envelope over a new grid, which it</span>
<span class="c1"># uses to interpolate each of the non-decreasing segments.</span>
<span class="n">m_upper</span><span class="p">,</span> <span class="n">v_upper</span><span class="p">,</span> <span class="n">inds_upper</span> <span class="o">=</span> <span class="n">upper_envelope</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>

<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">end</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_egm</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vt_egm</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_upper</span><span class="p">,</span> <span class="n">v_upper</span><span class="p">,</span> <span class="s2">&quot;.k&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;resources&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;transformed values&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/bb39d2e6b8d905e378e7dd8482573f05bacc938c8b81dbbb255893bfa07b861f.png" src="../_images/bb39d2e6b8d905e378e7dd8482573f05bacc938c8b81dbbb255893bfa07b861f.png" />
</div>
</div>
<p>And there we have it! a monotonic value without the sub-optimal points or reverse jumps!</p>
<p>Having introduced the main tools, we are now ready to apply DCEGM to a simple example.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="an-example-writing-a-will">
<h1>An example: writing a will<a class="headerlink" href="#an-example-writing-a-will" title="Link to this heading">#</a></h1>
<section id="author-mateo-velasquez-giraldo">
<h2>Author: <a class="reference external" href="https://mv77.github.io/">Mateo Velásquez-Giraldo</a><a class="headerlink" href="#author-mateo-velasquez-giraldo" title="Link to this heading">#</a></h2>
<p>We now present a basic example to illustrate the use of the previous tools in solving dynamic optimization problems with discrete and continuous decisions.</p>
<p>The model represents an agent that lives for three periods and decides how much of his resources to consume in each of them. On the second period, he must additionally decide whether to hire a lawyer to write a will. Having a will has the upside of allowing the agent to leave a bequest in his third and last period of life, which gives him utility, but has the downside that the lawyer will charge a fraction of his period 3 resources.</p>
<p>On each period, the agent receives a deterministic amount of resources <span class="math notranslate nohighlight">\(w\)</span>. The problem, therefore, is fully deterministic.</p>
<p>I now present the model formally, solving it backwards.</p>
<p>But first, some setup and calibration:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import tools for linear interpolation and finding optimal</span>
<span class="c1"># discrete choices.</span>

<span class="c1"># Import CRRA utility (and related) functions from HARK</span>

<span class="c1"># Solution method parameters</span>
<span class="n">aGrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>  <span class="c1"># Savings grid for EGM.</span>

<span class="c1"># Model parameters</span>

<span class="c1"># Parameters that need to be fixed</span>
<span class="c1"># Relative risk aversion. This is fixed at 2 in order to mantain</span>
<span class="c1"># the analytical solution that we use, from Carroll (2000)</span>
<span class="n">CRRA</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Parameters that can be changed.</span>
<span class="n">w</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Deterministic wage per period.</span>
<span class="c1"># Fraction of resources charged by lawyer for writing a will.</span>
<span class="n">willCstFac</span> <span class="o">=</span> <span class="mf">0.35</span>
<span class="n">DiscFac</span> <span class="o">=</span> <span class="mf">0.98</span>  <span class="c1"># Time-discount factor.</span>

<span class="c1"># Define utility (and related) functions</span>


<span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">CRRAutility</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">CRRA</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">uP</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">CRRAutilityP</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">CRRA</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">uPinv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">CRRAutilityP_inv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">CRRA</span><span class="p">)</span>


<span class="c1"># Create a grid for market resources</span>
<span class="n">mGrid</span> <span class="o">=</span> <span class="p">(</span><span class="n">aGrid</span> <span class="o">-</span> <span class="n">aGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1.5</span>
<span class="n">mGridPlots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">mGridPlotsC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mGridPlots</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Transformations for value funtion interpolation</span>


<span class="k">def</span> <span class="nf">vTransf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">vUntransf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="the-third-last-period-of-life">
<h1>The third (last) period of life<a class="headerlink" href="#the-third-last-period-of-life" title="Link to this heading">#</a></h1>
<p>In the last period of life, the agent’s problem is determined by his total amount of resources <span class="math notranslate nohighlight">\(m_3\)</span> and a state variable <span class="math notranslate nohighlight">\(W\)</span> that indicates whether he wrote a will (<span class="math notranslate nohighlight">\(W=1\)</span>) or not (<span class="math notranslate nohighlight">\(W=0\)</span>).</p>
<section id="the-agent-without-a-will">
<h2>The agent without a will<a class="headerlink" href="#the-agent-without-a-will" title="Link to this heading">#</a></h2>
<p>An agent who does not have a will simply consumes all of his available resources. Therefore, his value and consumption functions will be:</p>
<div class="amsmath math notranslate nohighlight" id="equation-97c8f221-3fb5-488c-851f-2e7664a3fb74">
<span class="eqno">(1)<a class="headerlink" href="#equation-97c8f221-3fb5-488c-851f-2e7664a3fb74" title="Permalink to this equation">#</a></span>\[\begin{equation}
V_3(m_3,W=0) = u(m_3)
\end{equation}\]</div>
<div class="amsmath math notranslate nohighlight" id="equation-1bafa576-8e6c-4b93-b99e-400101e4bced">
<span class="eqno">(2)<a class="headerlink" href="#equation-1bafa576-8e6c-4b93-b99e-400101e4bced" title="Permalink to this equation">#</a></span>\[\begin{equation}
c_3(m_3, W=0) = m_3
\end{equation}\]</div>
<p>Where <span class="math notranslate nohighlight">\(u(\cdot)\)</span> gives the utility from consumption. We assume a CRRA specification <span class="math notranslate nohighlight">\(u(c) = \frac{c^{1-\rho}}{1-\rho}\)</span>.</p>
</section>
<section id="the-agent-with-a-will">
<h2>The agent with a will<a class="headerlink" href="#the-agent-with-a-will" title="Link to this heading">#</a></h2>
<p>An agent who wrote a will decides how to allocate his available resources <span class="math notranslate nohighlight">\(m_3\)</span> between his consumption and a bequest. We assume an additive specification for the utility of a given consumption-bequest combination that follows a particular case in <a class="reference external" href="http://www.econ2.jhu.edu/people/ccarroll/Why.pdf">Carroll (2000)</a>. The component of utility from leaving a bequest <span class="math notranslate nohighlight">\(x\)</span> is assumed to be <span class="math notranslate nohighlight">\(\ln (x+1)\)</span>. Therefore, the agent’s value function is</p>
<div class="amsmath math notranslate nohighlight" id="equation-5ce2c3b0-443e-4b2d-b393-e0d6b636382c">
<span class="eqno">(3)<a class="headerlink" href="#equation-5ce2c3b0-443e-4b2d-b393-e0d6b636382c" title="Permalink to this equation">#</a></span>\[\begin{equation}
V_3(m_3, W=1) = \max_{0\leq c_3 \leq m_3} u(c_3) + \ln(m_3 - c_3 + 1)
\end{equation}\]</div>
<p>For ease of exposition we consider the case <span class="math notranslate nohighlight">\(\rho = 2\)</span>, where <a class="reference external" href="http://www.econ2.jhu.edu/people/ccarroll/Why.pdf">Carroll (2000)</a> shows that the optimal consumption level is given by</p>
<div class="amsmath math notranslate nohighlight" id="equation-b59c8e61-af52-481f-b08d-3fb52121b739">
<span class="eqno">(4)<a class="headerlink" href="#equation-b59c8e61-af52-481f-b08d-3fb52121b739" title="Permalink to this equation">#</a></span>\[\begin{equation}
c_3(m_3, W=1) = \min \left[m_3, \frac{-1 + \sqrt{1 + 4(m_3+1)}}{2} \right].
\end{equation}\]</div>
<p>The consumption function shows that <span class="math notranslate nohighlight">\(m_3=1\)</span> is the level of resources at which an important change of behavior occurs: agents leave bequests only for <span class="math notranslate nohighlight">\(m_3 &gt; 1\)</span>. Since an important change of behavior happens at this point, we call it a ‘kink-point’ and add it to our grids.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Agent without a will</span>
<span class="n">mGrid3_no</span> <span class="o">=</span> <span class="n">mGrid</span>
<span class="n">cGrid3_no</span> <span class="o">=</span> <span class="n">mGrid</span>
<span class="n">vGrid3_no</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="n">cGrid3_no</span><span class="p">)</span>

<span class="c1"># Create functions</span>
<span class="n">c3_no</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span><span class="n">mGrid3_no</span><span class="p">,</span> <span class="n">cGrid3_no</span><span class="p">)</span>  <span class="c1"># (0,0) is already here.</span>
<span class="n">vT3_no</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span><span class="n">mGrid3_no</span><span class="p">,</span> <span class="n">vTransf</span><span class="p">(</span><span class="n">vGrid3_no</span><span class="p">),</span> <span class="n">lower_extrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">v3_no</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">vUntransf</span><span class="p">(</span><span class="n">vT3_no</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="c1"># Agent with a will</span>

<span class="c1"># Define an auxiliary function with the analytical consumption expression</span>


<span class="k">def</span> <span class="nf">c3will</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>


<span class="c1"># Find the kink point</span>
<span class="n">mKink</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">indBelw</span> <span class="o">=</span> <span class="n">mGrid</span> <span class="o">&lt;</span> <span class="n">mKink</span>
<span class="n">indAbve</span> <span class="o">=</span> <span class="n">mGrid</span> <span class="o">&gt;</span> <span class="n">mKink</span>

<span class="n">mGrid3_wi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">mGrid</span><span class="p">[</span><span class="n">indBelw</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mKink</span><span class="p">]),</span> <span class="n">mGrid</span><span class="p">[</span><span class="n">indAbve</span><span class="p">]])</span>

<span class="n">cGrid3_wi</span> <span class="o">=</span> <span class="n">c3will</span><span class="p">(</span><span class="n">mGrid3_wi</span><span class="p">)</span>

<span class="n">cAbve</span> <span class="o">=</span> <span class="n">c3will</span><span class="p">(</span><span class="n">mGrid</span><span class="p">[</span><span class="n">indAbve</span><span class="p">])</span>
<span class="n">beqAbve</span> <span class="o">=</span> <span class="n">mGrid</span><span class="p">[</span><span class="n">indAbve</span><span class="p">]</span> <span class="o">-</span> <span class="n">c3will</span><span class="p">(</span><span class="n">mGrid</span><span class="p">[</span><span class="n">indAbve</span><span class="p">])</span>
<span class="n">vGrid3_wi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
    <span class="p">[</span><span class="n">u</span><span class="p">(</span><span class="n">mGrid</span><span class="p">[</span><span class="n">indBelw</span><span class="p">]),</span> <span class="n">u</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mKink</span><span class="p">])),</span> <span class="n">u</span><span class="p">(</span><span class="n">cAbve</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">beqAbve</span><span class="p">)]</span>
<span class="p">)</span>

<span class="c1"># Create functions</span>
<span class="n">c3_wi</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span><span class="n">mGrid3_wi</span><span class="p">,</span> <span class="n">cGrid3_wi</span><span class="p">)</span>  <span class="c1"># (0,0) is already here</span>
<span class="n">vT3_wi</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span><span class="n">mGrid3_wi</span><span class="p">,</span> <span class="n">vTransf</span><span class="p">(</span><span class="n">vGrid3_wi</span><span class="p">),</span> <span class="n">lower_extrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">v3_wi</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">vUntransf</span><span class="p">(</span><span class="n">vT3_wi</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mGridPlots</span><span class="p">,</span> <span class="n">v3_wi</span><span class="p">(</span><span class="n">mGridPlots</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Will&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mGridPlots</span><span class="p">,</span> <span class="n">v3_no</span><span class="p">(</span><span class="n">mGridPlots</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;No Will&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Period 3: Value functions&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Market resources&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mGridPlotsC</span><span class="p">,</span> <span class="n">c3_wi</span><span class="p">(</span><span class="n">mGridPlotsC</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Will&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mGridPlotsC</span><span class="p">,</span> <span class="n">c3_no</span><span class="p">(</span><span class="n">mGridPlotsC</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;No Will&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Period 3: Consumption Functions&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Market resources&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/71f1fb918189786abc5affd723cf188c322087133b1a97371f3cebabe740dfc8.png" src="../_images/71f1fb918189786abc5affd723cf188c322087133b1a97371f3cebabe740dfc8.png" />
<img alt="../_images/c7595a0f78a1061ed93fc4c7f27d7c9c4dcae7e387a3e323d745eb95633255de.png" src="../_images/c7595a0f78a1061ed93fc4c7f27d7c9c4dcae7e387a3e323d745eb95633255de.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="the-second-period">
<h1>The second period<a class="headerlink" href="#the-second-period" title="Link to this heading">#</a></h1>
<p>On the second period, the agent takes his resources as given (the only state variable) and makes two decisions:</p>
<ul class="simple">
<li><p>Whether to write a will or not.</p></li>
<li><p>What fraction of his resources to consume.</p></li>
</ul>
<p>These decisions can be seen as happening sequentially: the agent first decides whether to write a will or not, and then consumes optimally in accordance with his previous decision. Since we solve the model backwards in time, we first explore the consumption decision, conditional on the choice of writing a will or not.</p>
<section id="an-agent-who-decides-not-to-write-a-will">
<h2>An agent who decides not to write a will<a class="headerlink" href="#an-agent-who-decides-not-to-write-a-will" title="Link to this heading">#</a></h2>
<p>After deciding not to write a will, an agent solves the optimization problem expressed in the following conditional value function</p>
<div class="amsmath math notranslate nohighlight" id="equation-2c5bf2d1-a5aa-4a82-87d6-d8ef24300b71">
<span class="eqno">(5)<a class="headerlink" href="#equation-2c5bf2d1-a5aa-4a82-87d6-d8ef24300b71" title="Permalink to this equation">#</a></span>\[\begin{equation}
\begin{split}
\nu (m_2|w=0) &amp;= \max_{0\leq c \leq m_2} u(c) + \beta V_3(m_3,W=0)\\
s.t.&amp;\\
m_3 &amp;= m_2 - c + w
\end{split}
\end{equation}\]</div>
<p>We can approximate a solution to this problem through the method of endogenous gridpoints. This yields approximations to <span class="math notranslate nohighlight">\(\nu(\cdot|w=0)\)</span> and <span class="math notranslate nohighlight">\(c_2(\cdot|w=0)\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Second period, not writing a will</span>

<span class="c1"># Compute market resources at 3 with and without a will</span>
<span class="n">mGrid3_cond_nowi</span> <span class="o">=</span> <span class="n">aGrid</span> <span class="o">+</span> <span class="n">w</span>
<span class="c1"># Compute marginal value of assets in period 3 for each ammount of savings in 2</span>
<span class="n">vPGrid3_no</span> <span class="o">=</span> <span class="n">uP</span><span class="p">(</span><span class="n">c3_no</span><span class="p">(</span><span class="n">mGrid3_cond_nowi</span><span class="p">))</span>
<span class="c1"># Get consumption through EGM inversion of the euler equation</span>
<span class="n">cGrid2_cond_no</span> <span class="o">=</span> <span class="n">uPinv</span><span class="p">(</span><span class="n">DiscFac</span> <span class="o">*</span> <span class="n">vPGrid3_no</span><span class="p">)</span>

<span class="c1"># Get beginning-of-period market resources</span>
<span class="n">mGrid2_cond_no</span> <span class="o">=</span> <span class="n">aGrid</span> <span class="o">+</span> <span class="n">cGrid2_cond_no</span>

<span class="c1"># Compute value function</span>
<span class="n">vGrid2_cond_no</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="n">cGrid2_cond_no</span><span class="p">)</span> <span class="o">+</span> <span class="n">DiscFac</span> <span class="o">*</span> <span class="n">v3_no</span><span class="p">(</span><span class="n">mGrid3_cond_nowi</span><span class="p">)</span>

<span class="c1"># Create interpolating value and consumption functions</span>
<span class="n">vT2_cond_no</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span><span class="n">mGrid2_cond_no</span><span class="p">,</span> <span class="n">vTransf</span><span class="p">(</span><span class="n">vGrid2_cond_no</span><span class="p">),</span> <span class="n">lower_extrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">v2_cond_no</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">vUntransf</span><span class="p">(</span><span class="n">vT2_cond_no</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="n">c2_cond_no</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mGrid2_cond_no</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cGrid2_cond_no</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="an-agent-who-decides-to-write-a-will">
<h2>An agent who decides to write a will<a class="headerlink" href="#an-agent-who-decides-to-write-a-will" title="Link to this heading">#</a></h2>
<p>An agent who decides to write a will also solves for his consumption dinamically. We assume that the lawyer that helps the agent write his will takes some fraction <span class="math notranslate nohighlight">\(\tau\)</span> of his total resources in period 3. Therefore, the evolution of resources is given by <span class="math notranslate nohighlight">\(m_3 = (1-\tau)(m_2 - c_2 + w)\)</span>. The conditional value function of the agent is therefore:</p>
<div class="amsmath math notranslate nohighlight" id="equation-bf055044-2c41-431e-a9a1-b251bbf134e1">
<span class="eqno">(6)<a class="headerlink" href="#equation-bf055044-2c41-431e-a9a1-b251bbf134e1" title="Permalink to this equation">#</a></span>\[\begin{equation}
\begin{split}
\nu (m_2|w=1) &amp;= \max_{0\leq c \leq m_2} u(c) + \beta V_3(m_3,W=1)\\
s.t.&amp;\\
m_3 &amp;= (1-\tau)(m_2 - c + w)
\end{split}
\end{equation}\]</div>
<p>We also approximate a solution to this problem using the EGM. This yields approximations to <span class="math notranslate nohighlight">\(\nu(\cdot|w=1)\)</span> and <span class="math notranslate nohighlight">\(c_2(\cdot|w=1)\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Second period, writing a will</span>

<span class="c1"># Compute market resources at 3 with and without a will</span>
<span class="n">mGrid3_cond_will</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">willCstFac</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">aGrid</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span>
<span class="c1"># Compute marginal value of assets in period 3 for each ammount of savings in 2</span>
<span class="n">vPGrid3_wi</span> <span class="o">=</span> <span class="n">uP</span><span class="p">(</span><span class="n">c3_wi</span><span class="p">(</span><span class="n">mGrid3_cond_will</span><span class="p">))</span>
<span class="c1"># Get consumption through EGM inversion of the euler equation</span>
<span class="n">cGrid2_cond_wi</span> <span class="o">=</span> <span class="n">uPinv</span><span class="p">(</span><span class="n">DiscFac</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">willCstFac</span><span class="p">)</span> <span class="o">*</span> <span class="n">vPGrid3_wi</span><span class="p">)</span>
<span class="c1"># Get beginning-of-period market resources</span>
<span class="n">mGrid2_cond_wi</span> <span class="o">=</span> <span class="n">aGrid</span> <span class="o">+</span> <span class="n">cGrid2_cond_wi</span>

<span class="c1"># Compute value function</span>
<span class="n">vGrid2_cond_wi</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="n">cGrid2_cond_wi</span><span class="p">)</span> <span class="o">+</span> <span class="n">DiscFac</span> <span class="o">*</span> <span class="n">v3_wi</span><span class="p">(</span><span class="n">mGrid3_cond_will</span><span class="p">)</span>

<span class="c1"># Create interpolating value and consumption functions</span>
<span class="n">vT2_cond_wi</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span><span class="n">mGrid2_cond_wi</span><span class="p">,</span> <span class="n">vTransf</span><span class="p">(</span><span class="n">vGrid2_cond_wi</span><span class="p">),</span> <span class="n">lower_extrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">v2_cond_wi</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">vUntransf</span><span class="p">(</span><span class="n">vT2_cond_wi</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="n">c2_cond_wi</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mGrid2_cond_wi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">cGrid2_cond_wi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-decision-whether-to-write-a-will-or-not">
<h2>The decision whether to write a will or not<a class="headerlink" href="#the-decision-whether-to-write-a-will-or-not" title="Link to this heading">#</a></h2>
<p>With the conditional value functions at hand, we can now express and solve the decision of whether to write a will or not, and obtain the unconditional value and consumption functions.</p>
<div class="amsmath math notranslate nohighlight" id="equation-276d3b97-989b-4132-b6f1-daf9e8589139">
<span class="eqno">(7)<a class="headerlink" href="#equation-276d3b97-989b-4132-b6f1-daf9e8589139" title="Permalink to this equation">#</a></span>\[\begin{equation}
V_2(m_2) = \max \{ \nu (m_2|w=0), \nu (m_2|w=1) \}
\end{equation}\]</div>
<div class="amsmath math notranslate nohighlight" id="equation-68a590bb-d2f3-4bc7-9884-d093adaa1df9">
<span class="eqno">(8)<a class="headerlink" href="#equation-68a590bb-d2f3-4bc7-9884-d093adaa1df9" title="Permalink to this equation">#</a></span>\[\begin{equation}
w^*(m_2) = \arg \max_{w \in \{0,1\}} \{ \nu (m_2|w=w) \}
\end{equation}\]</div>
<div class="amsmath math notranslate nohighlight" id="equation-80d70999-8cbe-425a-a043-a116afb6f5d8">
<span class="eqno">(9)<a class="headerlink" href="#equation-80d70999-8cbe-425a-a043-a116afb6f5d8" title="Permalink to this equation">#</a></span>\[\begin{equation}
c_2(m_2) = c_2(m_2|w=w^*(m_2))
\end{equation}\]</div>
<p>We now construct these objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can use the upper_envelope function to find which action</span>
<span class="c1"># is optimal over the common grid of market resources, and</span>
<span class="c1"># insert the exact point in which the two actions yield equal value</span>
<span class="c1"># into the grid</span>
<span class="n">m2_env</span><span class="p">,</span> <span class="n">vt2_env</span><span class="p">,</span> <span class="n">inds2_env</span> <span class="o">=</span> <span class="n">upper_envelope</span><span class="p">(</span>
    <span class="p">[[</span><span class="n">mGrid</span><span class="p">,</span> <span class="n">vT2_cond_no</span><span class="p">(</span><span class="n">mGrid</span><span class="p">)],</span> <span class="p">[</span><span class="n">mGrid</span><span class="p">,</span> <span class="n">vT2_cond_wi</span><span class="p">(</span><span class="n">mGrid</span><span class="p">)]]</span>
<span class="p">)</span>

<span class="c1"># Plot the optimal decision rule</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m2_env</span><span class="p">,</span> <span class="n">inds2_env</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$w^*(m)$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Write will (1) or not (0)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Market resources: m&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># With the decision rule, we can find unconditional consumption</span>
<span class="n">c2_env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">m2_env</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="n">c2_env</span><span class="p">[</span><span class="n">inds2_env</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c2_cond_no</span><span class="p">(</span><span class="n">m2_env</span><span class="p">[</span><span class="n">inds2_env</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">c2_env</span><span class="p">[</span><span class="n">inds2_env</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c2_cond_wi</span><span class="p">(</span><span class="n">m2_env</span><span class="p">[</span><span class="n">inds2_env</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># And create the unconditional consumption and value functions</span>
<span class="n">vT2</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span><span class="n">m2_env</span><span class="p">,</span> <span class="n">vt2_env</span><span class="p">,</span> <span class="n">lower_extrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">v2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">vUntransf</span><span class="p">(</span><span class="n">vT2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="n">c2</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span><span class="n">m2_env</span><span class="p">,</span> <span class="n">c2_env</span><span class="p">,</span> <span class="n">lower_extrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># The &#39;kink&#39; is where the optimal action changes. Find its position to plot it</span>
<span class="n">kink_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">inds2_env</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span>

<span class="c1"># Plot the conditional and unconditional value functions</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m2_env</span><span class="p">,</span> <span class="n">v2_cond_wi</span><span class="p">(</span><span class="n">m2_env</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cond. Will&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m2_env</span><span class="p">,</span> <span class="n">v2_cond_no</span><span class="p">(</span><span class="n">m2_env</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cond. No will&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m2_env</span><span class="p">,</span> <span class="n">v2</span><span class="p">(</span><span class="n">m2_env</span><span class="p">),</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Uncond.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m2_env</span><span class="p">[</span><span class="n">kink_idx</span><span class="p">],</span> <span class="n">v2</span><span class="p">(</span><span class="n">m2_env</span><span class="p">[</span><span class="n">kink_idx</span><span class="p">]),</span> <span class="s2">&quot;rX&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Primary kink&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Period 2: Value Functions&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Market resources&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot the conditional and unconditional consumption</span>
<span class="c1"># functions</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m2_env</span><span class="p">,</span> <span class="n">c2_cond_wi</span><span class="p">(</span><span class="n">m2_env</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cond. Will&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m2_env</span><span class="p">,</span> <span class="n">c2_cond_no</span><span class="p">(</span><span class="n">m2_env</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cond. No will&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m2_env</span><span class="p">,</span> <span class="n">c2</span><span class="p">(</span><span class="n">m2_env</span><span class="p">),</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Uncond.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m2_env</span><span class="p">[</span><span class="n">kink_idx</span><span class="p">],</span> <span class="n">c2</span><span class="p">(</span><span class="n">m2_env</span><span class="p">[</span><span class="n">kink_idx</span><span class="p">]),</span> <span class="s2">&quot;rX&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Primary kink&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Period 2: Consumption Functions&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Market resources&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1dfa1f773941876dd873c19e617c9d96e6767a10e8e546befc5f4f539b480b25.png" src="../_images/1dfa1f773941876dd873c19e617c9d96e6767a10e8e546befc5f4f539b480b25.png" />
<img alt="../_images/48c945f0e829e33d3d715fd2116928449f96ef6227d5b7f1753ea1f561404771.png" src="../_images/48c945f0e829e33d3d715fd2116928449f96ef6227d5b7f1753ea1f561404771.png" />
<img alt="../_images/06eb2f823d336ed9f51e7ed86b94987408b0666bdc294ac10fbd301242fee2f6.png" src="../_images/06eb2f823d336ed9f51e7ed86b94987408b0666bdc294ac10fbd301242fee2f6.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="the-first-period">
<h1>The first period<a class="headerlink" href="#the-first-period" title="Link to this heading">#</a></h1>
<p>In the first period, the agent simply observes his market resources and decides what fraction of them to consume. His problem is represented by the following value function</p>
<div class="amsmath math notranslate nohighlight" id="equation-34c811b6-6069-4775-8bd0-901cf3cb48d7">
<span class="eqno">(10)<a class="headerlink" href="#equation-34c811b6-6069-4775-8bd0-901cf3cb48d7" title="Permalink to this equation">#</a></span>\[\begin{equation}
\begin{split}
V (m_1) &amp;= \max_{0\leq c \leq m_1} u(c) + \beta V_2(m_2)\\
s.t.&amp;\\
m_2 &amp;= m_1 - c + w.
\end{split}
\end{equation}\]</div>
<p>Although this looks like a simple problem, there are complications introduced by the kink in <span class="math notranslate nohighlight">\(V_2(\cdot)\)</span>, which is clearly visible in the plot from the previous block. Particularly, note that <span class="math notranslate nohighlight">\(V_2'(\cdot)\)</span> and <span class="math notranslate nohighlight">\(c_2(\cdot)\)</span> are not monotonic: there are now multiple points <span class="math notranslate nohighlight">\(m\)</span> for which the slope of <span class="math notranslate nohighlight">\(V_2(m)\)</span> is equal. Thus, the Euler equation becomes a necessary but not sufficient condition for optimality and the traditional EGM inversion step can generate non-monotonic endogenous <span class="math notranslate nohighlight">\(m\)</span> gridpoints.</p>
<p>We now illustrate this phenomenon.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># EGM step</span>

<span class="c1"># Period 2 resources implied by the exogenous savings grid</span>
<span class="n">mGrid2</span> <span class="o">=</span> <span class="n">aGrid</span> <span class="o">+</span> <span class="n">w</span>
<span class="c1"># Envelope condition</span>
<span class="n">vPGrid2</span> <span class="o">=</span> <span class="n">uP</span><span class="p">(</span><span class="n">c2</span><span class="p">(</span><span class="n">mGrid2</span><span class="p">))</span>
<span class="c1"># Inversion of the euler equation</span>
<span class="n">cGrid1</span> <span class="o">=</span> <span class="n">uPinv</span><span class="p">(</span><span class="n">DiscFac</span> <span class="o">*</span> <span class="n">vPGrid2</span><span class="p">)</span>
<span class="c1"># Endogenous gridpoints</span>
<span class="n">mGrid1</span> <span class="o">=</span> <span class="n">aGrid</span> <span class="o">+</span> <span class="n">cGrid1</span>
<span class="n">vGrid1</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="n">cGrid1</span><span class="p">)</span> <span class="o">+</span> <span class="n">DiscFac</span> <span class="o">*</span> <span class="n">v2</span><span class="p">(</span><span class="n">mGrid2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mGrid1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Endogenous gridpoints&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Position: i&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Endogenous grid point: $m_i$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mGrid1</span><span class="p">,</span> <span class="n">vGrid1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Value function at grid points&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Market resources: m&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Value function&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d588736caaaf65c6cd7a500373b7a345757425bd2f615a4d884e01434339558a.png" src="../_images/d588736caaaf65c6cd7a500373b7a345757425bd2f615a4d884e01434339558a.png" />
<img alt="../_images/cba81be3df182c955f6b44b57e1496a95dae8c667d4f5ef1ec436443f6053414.png" src="../_images/cba81be3df182c955f6b44b57e1496a95dae8c667d4f5ef1ec436443f6053414.png" />
</div>
</div>
<p>The previous cell applies the endogenous gridpoints method to the first period problem. The plots illustrate that the sequence of resulting endogenous gridpoints <span class="math notranslate nohighlight">\(\{m_i\}_{i=1}^N\)</span> is not monotonic. This results in intervals of market resources over which we have multiple candidate values for the value function. This is the point where we must apply the upper envelope function illustrated above.</p>
<p>We finally use the resulting consumption and value grid points to create the first period value and consumption functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate envelope</span>
<span class="c1"># The function operates with *transformed* value grids</span>
<span class="n">vTGrid1</span> <span class="o">=</span> <span class="n">vTransf</span><span class="p">(</span><span class="n">vGrid1</span><span class="p">)</span>

<span class="c1"># Form non-decreasing segments</span>
<span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">calc_nondecreasing_segments</span><span class="p">(</span><span class="n">mGrid1</span><span class="p">,</span> <span class="n">vTGrid1</span><span class="p">)</span>

<span class="n">m_segments</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">vT_segments</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">c_segments</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">end</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">m_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mGrid1</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">vT_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vTGrid1</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="n">c_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cGrid1</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

<span class="c1"># Get the upper envelope using m and vT</span>
<span class="n">m1_env</span><span class="p">,</span> <span class="n">vt1_env</span><span class="p">,</span> <span class="n">idx_1</span> <span class="o">=</span> <span class="n">upper_envelope</span><span class="p">(</span><span class="n">segments</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">m_segments</span><span class="p">,</span> <span class="n">vT_segments</span><span class="p">)))</span>

<span class="c1"># Store the index at which the optimal segment changes</span>
<span class="n">sec_kink_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">idx_1</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span>

<span class="c1"># Construct enveloped consumption</span>
<span class="n">c1_env</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">m1_env</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">c_segm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c_segments</span><span class="p">):</span>
    <span class="n">c1_env</span><span class="p">[</span><span class="n">idx_1</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span><span class="n">m_segments</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">c_segm</span><span class="p">)(</span><span class="n">m1_env</span><span class="p">[</span><span class="n">idx_1</span> <span class="o">==</span> <span class="n">k</span><span class="p">])</span>

<span class="c1"># Create functions</span>
<span class="n">c1_up</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span><span class="n">m1_env</span><span class="p">,</span> <span class="n">c1_env</span><span class="p">)</span>
<span class="n">v1T_up</span> <span class="o">=</span> <span class="n">LinearInterp</span><span class="p">(</span><span class="n">m1_env</span><span class="p">,</span> <span class="n">vt1_env</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">v1_up</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">vUntransf</span><span class="p">(</span><span class="n">v1T_up</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="c1"># Show that there is a non-monothonicity and that the upper envelope fixes it</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mGrid1</span><span class="p">,</span> <span class="n">vGrid1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;EGM Points&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m1_env</span><span class="p">,</span> <span class="n">v1_up</span><span class="p">(</span><span class="n">m1_env</span><span class="p">),</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upper Envelope&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m1_env</span><span class="p">[</span><span class="n">sec_kink_idx</span><span class="p">],</span> <span class="n">v1_up</span><span class="p">(</span><span class="n">m1_env</span><span class="p">[</span><span class="n">sec_kink_idx</span><span class="p">]),</span> <span class="s2">&quot;rX&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Crossings&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Period 1: Value function&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Market resources&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot consumption</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mGrid1</span><span class="p">,</span> <span class="n">cGrid1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;EGM Points&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m1_env</span><span class="p">,</span> <span class="n">c1_up</span><span class="p">(</span><span class="n">m1_env</span><span class="p">),</span> <span class="s2">&quot;k--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Upper Envelope&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">m1_env</span><span class="p">[</span><span class="n">sec_kink_idx</span><span class="p">],</span> <span class="n">c1_up</span><span class="p">(</span><span class="n">m1_env</span><span class="p">[</span><span class="n">sec_kink_idx</span><span class="p">]),</span> <span class="s2">&quot;rX&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Secondary Kink&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Period 1: Consumption function&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Market resources&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c8f8275dd1b913ea6bf4361f98b0d890514e3bb015461f1bad5aef4389fa3b12.png" src="../_images/c8f8275dd1b913ea6bf4361f98b0d890514e3bb015461f1bad5aef4389fa3b12.png" />
<img alt="../_images/634a42329db9d8084b7f1e1ea8fb2cbcadd04a502da1d25b1150afcfe408eb6e.png" src="../_images/634a42329db9d8084b7f1e1ea8fb2cbcadd04a502da1d25b1150afcfe408eb6e.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="references">
<h1>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h1>
<p>[1] Iskhakov, F. , Jørgensen, T. H., Rust, J. and Schjerning, B. (2017), The endogenous grid method for discrete‐continuous dynamic choice models with (or without) taste shocks. Quantitative Economics, 8: 317-365. doi:10.3982/QE643</p>
<p>[2] Carroll, C. D. (2006). The method of endogenous gridpoints for solving dynamic stochastic optimization problems. Economics letters, 91(3), 312-320.</p>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "econ-ark/DemARK",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Chinese-Growth.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Do Precautionary Motives Explain China’s High Saving Rate?</p>
      </div>
    </a>
    <a class="right-next"
       href="DiamondOLG.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">The Diamond OLG Model</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">DCEGM Upper Envelope</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-endogenous-grid-method-for-discrete-continuous-dynamic-choice-models-with-or-without-taste-shocks">“The endogenous grid method for discrete-continuous dynamic choice models with (or without) taste shocks”</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#upper-envelopes">Upper envelopes</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#an-example-writing-a-will">An example: writing a will</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#author-mateo-velasquez-giraldo">Author: Mateo Velásquez-Giraldo</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#the-third-last-period-of-life">The third (last) period of life</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-agent-without-a-will">The agent without a will</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-agent-with-a-will">The agent with a will</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#the-second-period">The second period</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-agent-who-decides-not-to-write-a-will">An agent who decides not to write a will</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-agent-who-decides-to-write-a-will">An agent who decides to write a will</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-decision-whether-to-write-a-will-or-not">The decision whether to write a will or not</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#the-first-period">The first period</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Econ-ARK Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>